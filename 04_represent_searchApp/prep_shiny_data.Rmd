


```{r}
library(tidyverse)
library(shiny)

load("../05_final_pipeline/.tmp03_allARCs.RData")

### Flatten ALL values into a 3-column (arc_id | key | value) df to provide search across "any field"

all_values <- do.call(
  rbind.data.frame, lapply(all_arcs_db, function(x){
  pivot_longer(x, cols = setdiff(colnames(x), "arc_id"), values_drop_na = T)}))

all_values <- as.data.frame(all_values)


# data.frame(unlist(lapply(all_arcs_db, colnames)))
# 
# ### Flatten all keys into a 2-column (key | list) df to use as search field selection
# 
# all_keys <- list()
# for(i in names(all_arcs_db)){
#   all_keys[[i]] <- data.frame(keys = names(all_arcs_db[[i]]), list = i)
# }
# 
# all_keys <- do.call(rbind.data.frame, all_keys)
# all_keys_cleaned <- subset(all_keys, keys != "arc_id")


shinyApp(
    ui = pageWithSidebar(
        headerPanel("CEPLAS-ARC Finder"),
        sidebarPanel(
            selectizeInput('search_key', 'Select a field to search', choices = c("choose" = "", unique(all_values$name))),
            uiOutput("search_field")
        ),
        
        mainPanel(
            tableOutput("table")
        )
    ),
    
    server = function(input, output, session) {
      
      
      ##### reactive input field for text-search
          
        
      output$search_field <- renderUI({
      
      value_choice <- reactive({
        
        unique(subset(all_values, name == input$search_key, "value", drop = T))
        
      })
      
      selectizeInput('search_value', 'Search the DB', choices = c(value_choice())) 
      
      })
      
      ##### reactive table output
      
        tab <- reactive({ 
          
          subset(all_values, name == input$search_key & value == input$search_value)
            
        })
      
        
      ##### render output table
        
        output$table <- renderTable({
            
            
          tab()
            
        })
        
    },
    
    options = list(height = 500)
    
)


```

